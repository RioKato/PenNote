# Injection Attack
---

## Basics
* インジェクション攻撃で攻撃のため挿入されるクエリは３パターンに大別できる

1. コメントアウトパターン
2. 対称パターン
3. ネストパターン


## コメントアウトパターン
* クエリがコメントアウトで終端するパターンである

* コメントアウト以降の構文を推測しなくともよいため、クエリの生成が容易
  ```
  PATTERN := CLOSE_SYMBOL* COMMAND COMMENT_OUT
  ```
  
* SQLインジェクションの例を上げる
  ```sql
  SELECT * FROM user WHERE name = 'admin' andw password = '' or 1=1 ;--' LIMIT 1
  ```
  
* パスワードに挿入されるクエリ（`' or 1=1 ;--`）は、文字列終端記号（`'`）とコマンド(`or 1=1;`)、コメントアウト（`--`）で構成される

* またOSコマンドインジェクションの例を上げる
  ```sh
  ping -c 10 ""; id;#"; echo "is alive?"
  ```
  
* 挿入されるクエリ（`"; id;#`）は、文字列終端記号（`"`）とコマンド（`; id;`）、コメントアウト（ `#`）で構成される

## 対称パターン

* サニタイズやWAFなどが原因で、コメントアウトがクエリに挿入できない時、利用するパターン
  ```
  PATTERN := CLOSE_SYMBOL* COMMAND START_SYMBOL*
  ```
  
* CLOSE_SYMBOLとSTART_SYMBOLに対称性があるのが特徴

* OSコマンドインジェクションの例を上げる
  ```sh
  echo "your home is"  $(grep "" /dev/null); id; $(cat"" /etc/passwd | cut -d: -f6)
  ```
  
* 挿入されるクエリ（`" /dev/null); id; $(cat"`）は、文字列終端記号（`"`）とコマンドがネストした場合の終端記号(`)`)、コマンド(`; id;`)、ネストした場合の開始記号(`$(`)、と文字列開始記号（`"`）で構成される

* **終端記号（`")`）と開始記号（`$("`）に対称性があることに注意**

* OSコマンドインジェクションにおいては、スペースを挿入しないことで、空の文字列の処理を行うことが可能

* 前記の例ではあえて`cat "`ではなく、`cat"`を挿入

* `cat"" /etc/passwd`は`cat /etc/passwd`と認識されるため、不要な文字列終端記号（`"`）を処理することが出来た

* 同様のケースは頻出するため、**OSコマンドインジェクションにおいては、文字列終端記号の前にスペースを挿入しないパターン**を試行した方がよい

## ネストパターン

* OSコマンドインジェクションのように、構文が間違っていても実行が中止されないようなインジェクションにおいて有効なパターン

* OSコマンドインジェクションの例をあげる

  ```sh
  ping -c 10 "$(id)"
  ```

* 挿入したクエリ（`$(id)`）は実行されるが、pingは入力値が間違っているため、実行されない
